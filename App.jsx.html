import React, { useState, useEffect, useRef } from 'react';
import { 
  ShoppingCart, Menu, X, ChevronRight, Star, Heart, 
  Facebook, Instagram, Tag, Info, MapPin, 
  FileText, ArrowLeft, Ruler, Calendar,
  CreditCard, Truck, Trash2, Package,
  User, Phone, Store, CheckCircle2, Loader2,
  LayoutDashboard, ClipboardList, Lock, Plus, Dna, Search, AlertCircle, ChevronLeft
} from 'lucide-react';

// --- 全域設定 ---
const ADMIN_PASSWORD = "6666"; 
const CATEGORIES = ['全部', '成蟲專區', '幼蟲專區', '優惠專區'];
const FB_URL = "https://www.facebook.com/profile.php?id=100064127917451";
const IG_URL = "https://www.instagram.com/happybeetle_2014/";
const COMMUNITY_URL = "https://tinyurl.com/4umnvwkm"; 

// --- 放大鏡查看元件 ---
const ZoomImage = ({ src, alt }) => {
  const [position, setPosition] = useState({ x: 0, y: 0 });
  const [showMagnifier, setShowMagnifier] = useState(false);

  const handleMouseMove = (e) => {
    const { left, top, width, height } = e.currentTarget.getBoundingClientRect();
    const x = ((e.pageX - left - window.pageXOffset) / width) * 100;
    const y = ((e.pageY - top - window.pageYOffset) / height) * 100;
    setPosition({ x, y });
  };

  return (
    <div 
      className="relative w-full h-full overflow-hidden cursor-zoom-in rounded-xl bg-white"
      onMouseEnter={() => setShowMagnifier(true)}
      onMouseLeave={() => setShowMagnifier(false)}
      onMouseMove={handleMouseMove}
    >
      <img 
        src={src} 
        alt={alt} 
        className={`w-full h-full object-contain transition-opacity duration-300 ${showMagnifier ? 'opacity-0' : 'opacity-100'}`}
      />
      {showMagnifier && (
        <div 
          className="absolute inset-0 bg-no-repeat pointer-events-none"
          style={{
            backgroundImage: `url(${src})`,
            backgroundPosition: `${position.x}% ${position.y}%`,
            backgroundSize: '250%',
          }}
        />
      )}
      <div className="absolute bottom-3 right-3 p-1.5 bg-black/20 backdrop-blur-md rounded-lg text-white pointer-events-none">
        <Search size={16} />
      </div>
    </div>
  );
};

const App = () => {
  // --- 狀態管理 ---
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [isCartOpen, setIsCartOpen] = useState(false);
  const [isWishlistOpen, setIsWishlistOpen] = useState(false);
  const [isCheckoutOpen, setIsCheckoutOpen] = useState(false); 
  const [isAdminOpen, setIsAdminOpen] = useState(false); 
  const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
  const [adminPasswordInput, setAdminPasswordInput] = useState('');
  const [adminLoginError, setAdminLoginError] = useState(false);

  const [orderComplete, setOrderComplete] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [checkoutError, setCheckoutError] = useState(''); 
  
  const [activeCategory, setActiveCategory] = useState('全部'); 
  const [cartItems, setCartItems] = useState([]); 
  const [favorites, setFavorites] = useState([]); 
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [orders, setOrders] = useState([]); 

  const [checkoutData, setCheckoutData] = useState({ name: '', phone: '', ig: '', shippingMethod: '7-11', destination: '' });
  const [currentSlide, setCurrentSlide] = useState(0);

  // --- 商品資料 ---
  const products = [
    { id: 1, name: '彩虹鍬形蟲 (琉璃色系) 成蟲成對', scientificName: 'Phalacrognathus muelleri', origin: '澳洲昆士蘭', size: '50mm x 37mm', eclosionDate: '2025年12月', parents: '60x37 琉璃血統', remarks: '目前皆蟄伏中，色澤深邃表現極佳。', category: '成蟲專區', price: 1000, stock: 5, image: 'https://i.meee.com.tw/MVMbxZE.jpg' },
    { id: 2, name: '彩虹鍬形蟲 (特選綠色系) 成蟲單母', scientificName: 'Phalacrognathus muelleri', origin: '澳洲昆士蘭', size: '37mm', eclosionDate: '2025年11月', parents: 'ALL x ALL', remarks: '種母級，色澤鮮艷，活動力佳。', category: '成蟲專區', price: 300, stock: 3, image: 'https://images.unsplash.com/photo-1541336032412-2048a678540d?auto=format&fit=crop&q=80&w=400' },
    { id: 3, name: '南洋大兜蟲 (CCC) L3 幼蟲', scientificName: 'Chalcosoma chiron chiron', origin: '爪哇島', size: 'L3 幼蟲', eclosionDate: '---', parents: '115mm x 60mm', remarks: '穩定進食中，頭幅巨大。', category: '幼蟲專區', price: 200, stock: 10, image: 'https://images.unsplash.com/photo-1574629810360-7efbbe195018?auto=format&fit=crop&q=80&w=400' },
    { id: 4, name: '赫克力士大兜蟲 L1 三入組', scientificName: 'Dynastes hercules hercules', origin: '瓜德羅普島', size: 'L1 幼蟲', eclosionDate: '---', parents: '160mm x 72mm', remarks: '強健血統，適合新手入門。', category: '優惠專區', price: 300, stock: 2, image: 'https://images.unsplash.com/photo-1548676924-48e71ceac151?auto=format&fit=crop&q=80&w=400' }
  ];

  const heroImages = [
    { id: 1, src: 'https://i.meee.com.tw/pckpEtz.jpg', alt: '展示 1' },
    { id: 2, src: 'https://i.meee.com.tw/qsvuGDt.jpg', alt: '展示 2' },
    { id: 3, src: 'https://i.meee.com.tw/90BZDVt.jpg', alt: '展示 3' },
  ];

  // --- 初始化與本地儲存同步 ---
  useEffect(() => {
    const savedOrders = localStorage.getItem('hb_orders');
    const savedFavorites = localStorage.getItem('hb_favorites');
    if (savedOrders) setOrders(JSON.parse(savedOrders));
    if (savedFavorites) setFavorites(JSON.parse(savedFavorites));
  }, []);

  useEffect(() => {
    localStorage.setItem('hb_favorites', JSON.stringify(favorites));
  }, [favorites]);

  // --- 輪播定時器 ---
  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentSlide((prev) => (prev + 1) % heroImages.length);
    }, 5000);
    return () => clearInterval(timer);
  }, [heroImages.length]);

  // --- 輔助功能 ---
  const isFavorited = (id) => favorites.some(p => p.id === id);
  const toggleFavorite = (e, product) => {
    if (e) e.stopPropagation();
    setFavorites(prev => {
      const exists = prev.some(p => p.id === product.id);
      if (exists) return prev.filter(p => p.id !== product.id);
      return [...prev, product];
    });
  };

  const cartSubtotal = cartItems.reduce((t, i) => t + (i.price * i.quantity), 0);
  const shippingFee = checkoutData.shippingMethod === '7-11' ? 70 : 120;
  const cartTotalPrice = cartSubtotal + shippingFee;
  const cartTotalCount = cartItems.reduce((t, i) => t + i.quantity, 0);

  const addToCart = (e, product) => {
    if (e) e.stopPropagation();
    setCartItems(prev => {
      const isExist = prev.find(item => item.id === product.id);
      if (isExist) return prev.map(item => item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item);
      return [...prev, { ...product, quantity: 1 }];
    });
    setIsCartOpen(true);
  };

  const removeFromCart = (id) => setCartItems(prev => prev.filter(i => i.id !== id));

  // --- 下單邏輯 ---
  const handleOrderSubmit = (e) => {
    e.preventDefault();
    setCheckoutError('');
    if (checkoutData.name.trim().length < 2) { setCheckoutError('請填寫真實姓名'); return; }
    if (checkoutData.phone.trim().length < 9) { setCheckoutError('請填寫手機號碼'); return; }
    if (checkoutData.ig.trim().length < 1) { setCheckoutError('請填寫 IG 帳號'); return; }
    if (!checkoutData.destination.trim()) { setCheckoutError('請填寫詳細配送資訊'); return; }

    setIsSubmitting(true);
    setTimeout(() => {
      const newOrder = {
        id: Date.now().toString(),
        customer: { 
          name: checkoutData.name, 
          phone: checkoutData.phone,
          ig: checkoutData.ig
        },
        shipping: { method: checkoutData.shippingMethod, destination: checkoutData.destination, fee: shippingFee },
        items: cartItems,
        total: cartTotalPrice,
        createdAt: new Date().toISOString()
      };
      const updatedOrders = [newOrder, ...orders];
      setOrders(updatedOrders);
      localStorage.setItem('hb_orders', JSON.stringify(updatedOrders));
      setOrderComplete(true);
      setCartItems([]);
      setIsSubmitting(false);
    }, 800);
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
      {/* 導覽列 */}
      <nav className="fixed w-full z-50 bg-white/80 backdrop-blur-md border-b border-sky-100 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16 md:h-20 font-bold">
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-2 cursor-pointer group" onClick={() => window.scrollTo({top:0, behavior:'smooth'})}>
                <div className="w-10 h-10 bg-sky-500 rounded-lg flex items-center justify-center text-yellow-300 shadow-lg transition-transform group-hover:scale-105">
                  <span className="font-bold text-lg">HB</span>
                </div>
                <div className="hidden sm:flex flex-col leading-tight">
                  <span className="font-bold text-sm md:text-base text-slate-900">H.B. 快樂蟲坊</span>
                  <span className="text-[8px] md:text-[10px] text-sky-600 font-black tracking-tighter uppercase">happybeetle store</span>
                </div>
              </div>
            </div>
            <div className="flex items-center space-x-2 md:space-x-4">
              <button onClick={() => setIsWishlistOpen(true)} className="p-2 text-slate-600 hover:text-pink-500 relative transition-colors">
                <Heart size={22} className={favorites.length > 0 ? "fill-pink-500 text-pink-500" : ""} />
                {favorites.length > 0 && <span className="absolute top-1 right-0 bg-pink-500 text-white text-[10px] font-black w-4 h-4 rounded-full flex items-center justify-center border-2 border-white">{favorites.length}</span>}
              </button>
              <button onClick={() => setIsCartOpen(true)} className="p-2 text-slate-600 hover:text-sky-500 relative transition-colors">
                <ShoppingCart size={22} />
                {cartTotalCount > 0 && <span className="absolute top-1 right-0 bg-yellow-400 text-slate-900 text-[10px] font-black w-4 h-4 rounded-full flex items-center justify-center border-2 border-white">{cartTotalCount}</span>}
              </button>
              <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="md:hidden p-2 text-slate-600">{isMenuOpen ? <X size={24} /> : <Menu size={24} />}</button>
            </div>
          </div>
        </div>
      </nav>

      {/* Hero 區塊 */}
      <section className="relative pt-24 md:pt-32 pb-12 md:pb-20 px-4 overflow-hidden">
        <div className="absolute top-0 right-0 w-1/3 h-full bg-sky-100/30 -z-10 rounded-bl-full"></div>
        <div className="max-w-7xl mx-auto grid md:grid-cols-2 gap-8 items-center">
          <div className="space-y-6 text-center md:text-left font-bold">
            <h1 className="text-4xl md:text-6xl font-black text-slate-900 leading-tight">透過昆蟲<br /><span className="text-sky-500 text-3xl md:text-5xl">來認識更多的人</span></h1>
            <p className="text-slate-500 text-sm md:text-base leading-relaxed">歡迎來到 H.B. 快樂蟲坊，精選高品質成蟲與幼蟲。<br/>從 2014 年起，致力於昆蟲飼育文化推廣。</p>
            <div className="flex flex-wrap justify-center md:justify-start gap-4">
              <button onClick={() => setIsCartOpen(true)} className="px-10 py-4 bg-sky-500 hover:bg-sky-600 text-white font-black rounded-2xl shadow-xl transition-all active:scale-95 shadow-sky-200">前往購物車</button>
              <a href={COMMUNITY_URL} target="_blank" rel="noopener noreferrer" className="px-10 py-4 bg-white border-2 border-sky-100 text-sky-600 font-black rounded-2xl hover:bg-sky-50 transition-all flex items-center justify-center">加入交流社群</a>
            </div>
          </div>
          <div className="relative group max-w-md mx-auto md:max-w-none w-full h-[350px] md:h-[450px]">
            <div className="relative h-full rounded-[2.5rem] overflow-hidden shadow-2xl bg-white border-4 border-white">
              {heroImages.map((slide, index) => (
                <div key={slide.id} className={`absolute inset-0 w-full h-full transition-all duration-1000 ease-in-out transform ${currentSlide === index ? 'opacity-100 scale-100 z-10' : 'opacity-0 scale-95 z-0'}`}>
                  <img src={slide.src} alt={slide.alt} className="w-full h-full object-contain p-4 bg-white" />
                </div>
              ))}
              <button onClick={() => setCurrentSlide((prev) => (prev - 1 + heroImages.length) % heroImages.length)} className="absolute left-4 top-1/2 -translate-y-1/2 z-20 p-2 bg-white/40 backdrop-blur-md rounded-full text-slate-800 opacity-0 group-hover:opacity-100 transition-all hover:bg-sky-500 hover:text-white shadow-sm"><ChevronLeft size={24} /></button>
              <button onClick={() => setCurrentSlide((prev) => (prev + 1) % heroImages.length)} className="absolute right-4 top-1/2 -translate-y-1/2 z-20 p-2 bg-white/40 backdrop-blur-md rounded-full text-slate-800 opacity-0 group-hover:opacity-100 transition-all hover:bg-sky-500 hover:text-white shadow-sm"><ChevronRight size={24} /></button>
            </div>
          </div>
        </div>
      </section>

      {/* 商城區 */}
      <section className="py-12 md:py-20 px-4 bg-white font-bold">
        <div className="max-w-7xl mx-auto">
          <div className="mb-12 border-b border-slate-100 pb-8">
            <h2 className="text-2xl md:text-3xl font-black text-slate-900 mb-6 tracking-tight">精選商城</h2>
            <div className="flex flex-wrap gap-2 font-black">
              {CATEGORIES.map(cat => (
                <button key={cat} onClick={() => setActiveCategory(cat)} className={`px-6 py-2 rounded-xl text-xs md:text-sm transition-all ${activeCategory === cat ? 'bg-sky-500 text-white shadow-lg scale-105' : 'bg-slate-100 text-slate-500 hover:bg-sky-50'}`}>{cat}</button>
              ))}
            </div>
          </div>

          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6 font-bold">
            {(activeCategory === '全部' ? products : products.filter(p => p.category === activeCategory)).map(product => (
              <div key={product.id} onClick={() => setSelectedProduct(product)} className="group bg-white rounded-2xl border border-slate-100 overflow-hidden hover:shadow-xl transition-all transform hover:-translate-y-1 cursor-pointer flex flex-col font-bold">
                <div className="relative aspect-square overflow-hidden bg-white p-3 border-b border-slate-50">
                  <img src={product.image} alt={product.name} className="w-full h-full object-contain transition-transform duration-700 group-hover:scale-110" />
                  <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                    <Search size={24} className="text-sky-500" />
                  </div>
                </div>
                <div className="p-3 md:p-4 flex flex-col flex-1 font-bold">
                  <h3 className="text-sm md:text-base font-black text-slate-800 mb-2 h-10 overflow-hidden line-clamp-2">{product.name}</h3>
                  <div className="text-[10px] text-slate-400 mb-3 flex items-center gap-1 font-bold"><Package size={14} /> 庫存: {product.stock}</div>
                  <div className="mt-auto flex justify-between items-center gap-2">
                    <span className="text-base md:text-lg font-black text-slate-900">NT$ {product.price.toLocaleString()}</span>
                    <div className="flex gap-1.5 font-bold">
                      <button 
                        onClick={(e) => toggleFavorite(e, product)} 
                        className={`w-8 h-8 rounded-full flex items-center justify-center transition-all shadow-sm ${isFavorited(product.id) ? 'bg-pink-50 text-pink-500' : 'bg-slate-50 text-slate-300 hover:text-pink-500'}`}
                      >
                        <Heart size={16} className={isFavorited(product.id) ? "fill-pink-500" : ""} />
                      </button>
                      <button 
                        onClick={(e) => addToCart(e, product)} 
                        className="w-8 h-8 rounded-full bg-sky-50 text-sky-500 hover:bg-sky-500 hover:text-white flex items-center justify-center transition-all shadow-sm"
                      >
                        <Plus size={16} />
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* 詳情 Modal */}
      {selectedProduct && (
        <div className="fixed inset-0 z-[1000] flex items-center justify-center px-4 py-6 overflow-hidden">
          <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={() => setSelectedProduct(null)}></div>
          <div className="relative bg-white w-full max-w-5xl rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col md:flex-row animate-in fade-in zoom-in duration-300 max-h-[95vh] font-bold">
            <div className="md:w-1/2 bg-white flex items-center justify-center p-6 border-b md:border-b-0 md:border-r border-slate-100 overflow-hidden relative">
              <ZoomImage src={selectedProduct.image} alt={selectedProduct.name} />
              <button onClick={() => setSelectedProduct(null)} className="absolute top-4 left-4 p-2 bg-white/80 backdrop-blur-md rounded-full md:hidden shadow-sm font-bold"><X size={20}/></button>
            </div>
            <div className="md:w-1/2 p-6 md:p-10 overflow-y-auto space-y-6">
                <div className="flex justify-between items-start font-bold">
                  <div>
                    <div className="flex items-center gap-2 text-sky-500 font-bold text-xs mb-2 tracking-widest uppercase"><Tag size={14} /> {selectedProduct.category}</div>
                    <h2 className="text-2xl md:text-3xl font-black text-slate-900 tracking-tight leading-tight">{selectedProduct.name}</h2>
                    <div className="text-2xl font-black text-sky-600 mt-1">NT$ {selectedProduct.price.toLocaleString()}</div>
                  </div>
                  <X className="cursor-pointer text-slate-300 hover:text-slate-900 hidden md:block" onClick={() => setSelectedProduct(null)} />
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 font-bold">
                  <div className="flex items-start gap-3 p-3 bg-slate-50 rounded-xl">
                    <Info className="text-sky-500 shrink-0" size={16} />
                    <div><p className="text-[10px] font-black text-slate-400 uppercase font-bold">學名</p><p className="text-xs italic">{selectedProduct.scientificName}</p></div>
                  </div>
                  <div className="flex items-start gap-3 p-3 bg-slate-50 rounded-xl">
                    <Ruler className="text-sky-500 shrink-0" size={16} />
                    <div><p className="text-[10px] font-black text-slate-400 uppercase font-bold">規格</p><p className="text-xs">{selectedProduct.size}</p></div>
                  </div>
                  <div className="flex items-start gap-3 p-3 bg-slate-50 rounded-xl">
                    <MapPin className="text-sky-500 shrink-0" size={16} />
                    <div><p className="text-[10px] font-black text-slate-400 uppercase font-bold">產地</p><p className="text-xs">{selectedProduct.origin}</p></div>
                  </div>
                  <div className="flex items-start gap-3 p-3 bg-slate-50 rounded-xl">
                    <Calendar className="text-sky-500 shrink-0" size={16} />
                    <div><p className="text-[10px] font-black text-slate-400 uppercase font-bold">羽化日期</p><p className="text-xs">{selectedProduct.eclosionDate}</p></div>
                  </div>
                  <div className="flex items-start gap-3 p-3 bg-slate-50 rounded-xl sm:col-span-2">
                    <Dna className="text-sky-500 shrink-0" size={16} />
                    <div><p className="text-[10px] font-black text-slate-400 uppercase font-bold">親代</p><p className="text-xs">{selectedProduct.parents}</p></div>
                  </div>
                  <div className="flex items-start gap-3 p-3 bg-slate-50 rounded-xl sm:col-span-2 font-bold">
                    <FileText className="text-yellow-600 shrink-0" size={16} />
                    <div><p className="text-[10px] font-black text-slate-400 uppercase font-bold">備註</p><p className="text-xs font-medium leading-relaxed">{selectedProduct.remarks}</p></div>
                  </div>
                </div>
                <div className="flex gap-3 pt-2 font-bold">
                  <button onClick={() => addToCart(null, selectedProduct)} className="flex-1 py-4 bg-sky-500 text-white font-black rounded-2xl shadow-xl hover:bg-sky-600 transition-all flex items-center justify-center gap-2 active:scale-95">
                    <ShoppingCart size={20} /> 立即購買
                  </button>
                  <button onClick={(e) => toggleFavorite(e, selectedProduct)} className={`p-4 rounded-2xl border transition-all active:scale-90 ${isFavorited(selectedProduct.id) ? 'bg-pink-50 border-pink-100 text-pink-500' : 'bg-slate-50 border-slate-100 text-slate-400'}`}><Heart size={20} className={isFavorited(selectedProduct.id) ? "fill-pink-500" : ""} /></button>
                </div>
            </div>
          </div>
        </div>
      )}

      {/* 結帳 Modal */}
      {isCheckoutOpen && (
        <div className="fixed inset-0 z-[1200] flex items-center justify-center px-4 py-6 overflow-hidden">
          <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={() => !orderComplete && !isSubmitting && setIsCheckoutOpen(false)}></div>
          <div className="relative bg-white w-full max-w-2xl h-full md:h-auto md:max-h-[90vh] rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col animate-in fade-in zoom-in duration-300 font-bold">
            {orderComplete ? (
              <div className="p-12 text-center flex flex-col items-center justify-center h-full space-y-6">
                <CheckCircle2 size={64} className="text-green-500 animate-bounce" />
                <h2 className="text-3xl font-black">下單成功！</h2>
                <p className="text-slate-500">感謝您的訂購，我們會盡快處理。</p>
                <button onClick={() => { setIsCheckoutOpen(false); setOrderComplete(false); setIsCartOpen(false); }} className="px-10 py-4 bg-slate-900 text-white font-black rounded-2xl font-bold">返回首頁</button>
              </div>
            ) : (
              <div className="flex flex-col h-full overflow-hidden">
                <div className="p-6 md:p-8 border-b flex justify-between items-center bg-slate-50/50 font-black">
                  <h3 className="text-xl font-black flex items-center gap-2 tracking-tight"><CreditCard className="text-sky-500" /> 結帳資訊</h3>
                  <X className="cursor-pointer" onClick={()=>setIsCheckoutOpen(false)}/>
                </div>
                <form onSubmit={handleOrderSubmit} className="flex-1 overflow-y-auto p-6 md:p-8 space-y-6">
                  <div className="bg-slate-900 text-white p-6 rounded-[2rem] space-y-3 shadow-lg">
                    <div className="flex justify-between text-slate-400 text-sm"><span>商品合計</span><span>$ {cartSubtotal.toLocaleString()}</span></div>
                    <div className="flex justify-between text-slate-400 text-sm"><span>配送費用</span><span>+ $ {shippingFee}</span></div>
                    <div className="flex justify-between text-2xl font-black border-t border-white/10 pt-3 mt-2"><span className="text-yellow-400">應付總額</span><span className="text-yellow-400">$ {cartTotalPrice.toLocaleString()}</span></div>
                  </div>

                  {checkoutError && (
                    <div className="flex items-center gap-2 p-4 bg-red-50 text-red-500 rounded-2xl border border-red-200 animate-shake font-bold">
                      <AlertCircle size={20} />
                      <span className="text-sm font-black">{checkoutError}</span>
                    </div>
                  )}

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="space-y-1 font-bold">
                      <label className="text-[10px] font-black text-slate-400 uppercase ml-2">收件人全名 (必填)</label>
                      <input required type="text" value={checkoutData.name} onChange={(e)=>setCheckoutData({...checkoutData, name: e.target.value})} className="w-full bg-slate-100 border-none rounded-xl px-4 py-3 font-bold focus:ring-2 focus:ring-sky-500 outline-none" placeholder="真實姓名" />
                    </div>
                    <div className="space-y-1 font-bold">
                      <label className="text-[10px] font-black text-slate-400 uppercase ml-2">手機號碼 (必填)</label>
                      <input required type="tel" value={checkoutData.phone} onChange={(e)=>setCheckoutData({...checkoutData, phone: e.target.value})} className="w-full bg-slate-100 border-none rounded-xl px-4 py-3 font-bold focus:ring-2 focus:ring-sky-500 outline-none" placeholder="09xx-xxx-xxx" />
                    </div>
                  </div>

                  {/* IG 帳號欄位與備註 */}
                  <div className="space-y-1 font-bold">
                    <div className="flex justify-between items-center ml-2">
                       <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Instagram 帳號 (必填)</label>
                       <span className="text-[9px] text-sky-500 font-bold bg-sky-50 px-2 py-0.5 rounded-full animate-pulse border border-sky-100">下單後聯繫提供匯款帳號</span>
                    </div>
                    <input required type="text" value={checkoutData.ig} onChange={(e)=>setCheckoutData({...checkoutData, ig: e.target.value})} className="w-full bg-slate-100 border-none rounded-xl px-4 py-3 font-bold focus:ring-2 focus:ring-sky-500 outline-none" placeholder="@ig_account" />
                  </div>

                  <div className="space-y-3 font-bold">
                    <label className="text-xs font-black text-slate-400 ml-1">配送方式</label>
                    <div className="grid grid-cols-2 gap-3">
                      <div onClick={() => setCheckoutData({...checkoutData, shippingMethod: '7-11', destination: ''})} className={`cursor-pointer p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-2 ${checkoutData.shippingMethod === '7-11' ? 'border-sky-500 bg-sky-50 shadow-md shadow-sky-100 font-bold' : 'border-slate-100 bg-white'}`}>
                        <Store className={checkoutData.shippingMethod === '7-11' ? 'text-sky-500' : 'text-slate-400'} />
                        <span className="text-sm font-bold font-bold">7-11 店到店</span>
                      </div>
                      <div onClick={() => setCheckoutData({...checkoutData, shippingMethod: 'blackcat', destination: ''})} className={`cursor-pointer p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-2 ${checkoutData.shippingMethod === 'blackcat' ? 'border-sky-500 bg-sky-50 shadow-md shadow-sky-100 font-bold' : 'border-slate-100 bg-white'}`}>
                        <Truck className={checkoutData.shippingMethod === 'blackcat' ? 'text-sky-500' : 'text-slate-400'} />
                        <span className="text-sm font-bold font-bold">黑貓宅配</span>
                      </div>
                    </div>
                  </div>

                  <div className="space-y-1 pb-6 font-bold font-bold">
                    <label className="text-[10px] font-black text-slate-400 uppercase ml-2 font-bold tracking-widest">{checkoutData.shippingMethod === '7-11' ? '門市名稱 (必填)' : '收件完整地址 (必填)'}</label>
                    <textarea required rows="2" value={checkoutData.destination} onChange={(e)=>setCheckoutData({...checkoutData, destination: e.target.value})} className="w-full bg-slate-100 border-none rounded-xl px-4 py-3 font-bold focus:ring-2 focus:ring-sky-500 outline-none resize-none transition-all font-bold" placeholder={checkoutData.shippingMethod === '7-11' ? '例如：快樂門市名稱' : '例如：完整地址'}></textarea>
                  </div>

                  <button disabled={isSubmitting} type="submit" className="w-full py-4 bg-sky-500 text-white font-black rounded-2xl shadow-xl hover:bg-sky-600 flex items-center justify-center gap-2 transition-all active:scale-95 mb-4 shadow-sky-200">
                    {isSubmitting ? <Loader2 className="animate-spin font-black" /> : '確認下單'}
                  </button>
                </form>
              </div>
            )}
          </div>
        </div>
      )}

      {/* 隱藏後台入口與介面 */}
      {isAdminOpen && (
        <div className="fixed inset-0 z-[2000] flex items-center justify-center px-4 py-6 overflow-hidden font-bold">
          <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-xl" onClick={() => setIsAdminOpen(false)}></div>
          <div className="relative bg-white w-full max-w-6xl h-[90vh] rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col animate-in fade-in zoom-in duration-300">
            {!isAdminAuthenticated ? (
              <div className="flex-1 flex flex-col items-center justify-center p-8 space-y-6 text-center font-bold">
                <Lock size={48} className="text-sky-500 font-bold" />
                <h3 className="text-2xl font-black">管理者登入</h3>
                <form onSubmit={(e) => {e.preventDefault(); if(adminPasswordInput===ADMIN_PASSWORD) {setIsAdminAuthenticated(true); setAdminLoginError(false);} else {setAdminLoginError(true);}}} className="w-full max-w-xs space-y-4">
                  <input type="password" value={adminPasswordInput} onChange={(e) => setAdminPasswordInput(e.target.value)} placeholder="管理密碼" className={`w-full px-6 py-4 bg-slate-100 border-2 rounded-2xl text-center font-bold outline-none transition-all ${adminLoginError ? 'border-red-400 bg-red-50' : 'border-transparent focus:border-sky-500'}`} />
                  <button type="submit" className="w-full py-4 bg-sky-500 text-white font-black rounded-2xl shadow-lg">進入後台</button>
                </form>
              </div>
            ) : (
              <>
                <div className="p-8 border-b flex justify-between items-center bg-slate-50/50 shadow-sm font-black">
                  <h3 className="text-2xl flex items-center gap-3"><LayoutDashboard size={28} className="text-sky-500" /> 訂單管理系統</h3>
                  <div className="flex gap-3">
                    <button onClick={()=>{setIsAdminAuthenticated(false); setAdminPasswordInput('');}} className="px-4 py-2 bg-white text-red-500 border border-red-100 rounded-xl text-sm font-bold shadow-sm transition-all hover:bg-red-50">登出</button>
                    <button onClick={() => setIsAdminOpen(false)} className="w-12 h-12 bg-white border border-slate-200 rounded-full flex items-center justify-center shadow-sm hover:bg-slate-50 transition-all font-bold"><X size={24} /></button>
                  </div>
                </div>
                <div className="flex-1 overflow-y-auto p-8 space-y-6">
                  {orders.length === 0 ? (
                    <div className="h-full flex flex-col items-center justify-center text-slate-400 opacity-50 font-bold"><ClipboardList size={64} /><p className="text-lg font-bold">目前尚未收到訂單</p></div>
                  ) : (
                    orders.map((order) => (
                      <div key={order.id} className="bg-white border border-slate-100 rounded-3xl p-6 shadow-sm hover:shadow-md transition-all font-bold">
                          <div className="flex flex-col lg:flex-row justify-between gap-6">
                            <div className="flex-1 space-y-2 font-bold">
                              <span className="bg-sky-100 text-sky-600 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest tracking-tighter">NEW ORDER</span>
                              <h4 className="text-xl font-black text-slate-900">{order.customer?.name}</h4>
                              <p className="text-slate-500 flex items-center gap-2 font-bold"><Phone size={14} /> {order.customer?.phone}</p>
                              <p className="text-sky-600 flex items-center gap-2 font-bold"><Instagram size={14} /> {order.customer?.ig || '未提供'}</p>
                              <div className="p-4 bg-slate-50 rounded-2xl mt-4 border border-slate-100 font-medium font-bold"><p className="text-[10px] font-black text-slate-400 uppercase mb-1 tracking-tighter">配送資訊</p><p className="text-sm font-bold text-slate-700">{order.shipping?.method === '7-11' ? '7-11 店到店' : '黑貓宅配'}: {order.shipping?.destination}</p></div>
                            </div>
                            <div className="flex-1 lg:border-l border-slate-100 lg:pl-6 space-y-4 font-bold font-bold">
                              <p className="text-[10px] font-black text-slate-400 uppercase font-bold">購買項目明細</p>
                              <div className="space-y-2 font-medium font-bold">{order.items?.map((item, i) => (<div key={i} className="flex justify-between text-sm"><span>{item.name} <span className="text-sky-500 font-bold">x{item.quantity}</span></span><span className="text-slate-400">$ {(item.price * item.quantity).toLocaleString()}</span></div>))}</div>
                              <div className="pt-4 border-t border-dashed border-slate-200 flex justify-between items-end font-black">
                                <p className="text-lg font-black text-sky-600 font-black font-black">實付總額</p>
                                <span className="text-3xl font-black text-slate-900 font-black font-black font-black">$ {order.total?.toLocaleString()}</span>
                              </div>
                            </div>
                          </div>
                      </div>
                    ))
                  )}
                </div>
              </>
            )}
          </div>
        </div>
      )}

      {/* 購物車側邊欄 (z-index 1100) */}
      {isCartOpen && (
        <div className="fixed inset-0 z-[1100] overflow-hidden font-bold">
          <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm font-bold" onClick={() => setIsCartOpen(false)}></div>
          <div className="absolute right-0 top-0 h-full w-full max-w-sm bg-white shadow-2xl flex flex-col animate-in slide-in-from-right duration-300 font-bold">
            <div className="flex justify-between items-center p-6 border-b font-black font-black"><h3 className="text-lg font-bold flex items-center gap-2 font-black tracking-tight"><ShoppingCart className="text-sky-500 font-bold" /> 購物車 ({cartTotalCount})</h3><button onClick={() => setIsCartOpen(false)} className="p-2 hover:bg-slate-100 rounded-full transition-colors font-bold"><X size={20} /></button></div>
            <div className="flex-1 overflow-y-auto p-6 space-y-4 font-bold">
              {cartItems.length === 0 ? (
                <div className="h-full flex flex-col items-center justify-center text-slate-400 text-center space-y-4 opacity-50 font-bold font-bold"><ShoppingCart size={48} /><p className="font-bold text-sm tracking-tighter uppercase font-black font-bold">購物車是空的</p></div>
              ) : (
                cartItems.map(item => (
                  <div key={item.id} className="flex gap-4 p-4 bg-slate-50 rounded-2xl group border border-transparent hover:border-sky-100 shadow-sm transition-all font-bold font-bold font-bold">
                    <div className="w-16 h-16 bg-white rounded-xl overflow-hidden shrink-0 border border-slate-100 p-1 flex items-center justify-center font-bold"><img src={item.image} alt={item.name} className="w-full h-full object-contain" /></div>
                    <div className="flex-1 flex flex-col font-bold">
                      <div className="flex justify-between items-start font-bold font-bold"><h4 className="text-sm font-bold line-clamp-2">{item.name}</h4><button onClick={() => removeFromCart(item.id)} className="text-slate-300 hover:text-red-500 transition-colors font-bold"><Trash2 size={16} /></button></div>
                      <div className="mt-auto flex justify-between items-center font-bold"><p className="text-xs text-sky-600 font-black">NT$ {item.price.toLocaleString()}</p><span className="text-xs text-slate-600 tracking-tighter font-black font-bold font-bold">x{item.quantity}</span></div>
                    </div>
                  </div>
                ))
              )}
            </div>
            {cartItems.length > 0 && (
              <div className="p-6 border-t bg-slate-50/50 space-y-4 shadow-inner font-black font-black">
                <div className="flex justify-between items-center text-slate-900 font-black"><span>商品合計</span><span className="text-2xl font-black text-sky-600 font-black">NT$ {cartSubtotal.toLocaleString()}</span></div>
                <div className="grid grid-cols-2 gap-3 font-bold font-bold"><button onClick={() => setIsCartOpen(false)} className="py-3 bg-white border border-sky-100 text-sky-600 font-bold rounded-xl hover:bg-sky-50 transition-all font-black font-bold">繼續選購</button><button onClick={() => setIsCheckoutOpen(true)} className="py-3 bg-sky-500 text-white font-black rounded-xl hover:bg-sky-600 shadow-lg transition-all font-black shadow-sky-200">去結帳</button></div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* 我的最愛側邊欄 (z-index 1100) */}
      {isWishlistOpen && (
        <div className="fixed inset-0 z-[1100] overflow-hidden font-bold">
          <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm font-bold" onClick={() => setIsWishlistOpen(false)}></div>
          <div className="absolute right-0 top-0 h-full w-full max-w-sm bg-white shadow-2xl flex flex-col animate-in slide-in-from-right duration-300 font-bold">
            <div className="flex justify-between items-center p-6 border-b font-black font-black font-black font-black font-black"><h3 className="text-lg font-bold flex items-center gap-2 font-black tracking-tight"><Heart className="text-pink-500 fill-pink-500 font-bold font-bold font-bold" /> 我的最愛</h3><button onClick={() => setIsWishlistOpen(false)} className="p-2 hover:bg-slate-100 rounded-full transition-colors font-bold"><X size={20} /></button></div>
            <div className="flex-1 overflow-y-auto p-6 space-y-4 font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold">
              {favorites.length === 0 ? (
                <div className="h-full flex flex-col items-center justify-center text-slate-400 text-center space-y-4 opacity-50 font-bold"><Heart size={48} /><p className="font-bold text-sm tracking-tighter uppercase font-black font-bold font-bold">尚未收藏</p></div>
              ) : (
                favorites.map(item => (
                  <div key={item.id} className="flex gap-4 p-4 bg-slate-50 rounded-2xl group border border-transparent hover:border-pink-100 transition-all shadow-sm font-bold font-bold font-bold">
                    <div className="w-16 h-16 bg-white rounded-xl overflow-hidden shrink-0 border border-slate-100 p-1 flex items-center justify-center font-bold"><img src={item.image} alt={item.name} className={`w-full h-full object-contain`} /></div>
                    <div className="flex-1 flex flex-col font-bold">
                      <h4 className="text-sm font-bold line-clamp-1">{String(item.name)}</h4>
                      <div className="mt-auto flex gap-2 font-bold font-bold font-bold font-bold">
                        <button onClick={() => addToCart(null, item)} className="flex-1 py-1.5 bg-sky-500 text-white rounded-lg text-[10px] font-bold shadow-md hover:bg-sky-600 transition-all font-black font-bold font-bold font-bold font-bold">加入購物車</button>
                        <button onClick={(e) => toggleFavorite(e, item)} className="p-2 bg-white text-slate-300 hover:text-red-500 border border-slate-100 rounded-lg shadow-sm transition-all font-bold font-black"><Trash2 size={14} /></button>
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      )}

      {/* 頁腳 */}
      <footer className="bg-slate-900 text-slate-300 py-12 px-4 text-center md:text-left shadow-inner font-bold font-bold font-bold font-bold">
        <div className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-12 font-black font-black font-black font-black font-black">
          <div className="col-span-1 font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold">
            <div className="flex items-center justify-center md:justify-start gap-2 mb-6 font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold"><div className="w-8 h-8 bg-sky-500 rounded flex items-center justify-center text-yellow-300 font-bold shadow-lg">HB</div><span className="font-bold text-lg md:text-xl text-white tracking-tight uppercase font-black font-black font-black font-black font-black font-black font-black font-black font-black">Happy Beetle</span></div>
            <p className="text-xs opacity-70 leading-relaxed font-medium mb-6 font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold">自 2014 年起，致力於昆蟲飼育文化推廣。<br/>透過生命遇見更多熱愛自然的朋友。</p>
            <div className="flex justify-center md:justify-start items-center gap-4 font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold">
              <a href={FB_URL} target="_blank" rel="noopener noreferrer" className="w-10 h-10 bg-slate-800 rounded-full flex items-center justify-center hover:bg-sky-500 transition-all shadow-lg group font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold" title="Facebook Page"><Facebook size={20} className="text-slate-300 group-hover:text-white font-bold" /></a>
              <a href={IG_URL} target="_blank" rel="noopener noreferrer" className="w-10 h-10 bg-slate-800 rounded-full flex items-center justify-center hover:bg-pink-500 transition-all shadow-lg group font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold" title="Instagram Profile"><Instagram size={20} className="text-slate-300 group-hover:text-white font-bold" /></a>
            </div>
          </div>
        </div>
        <div className="max-w-7xl mx-auto mt-12 pt-8 border-t border-white/5 text-[10px] text-slate-500 select-none tracking-widest uppercase flex flex-col md:flex-row justify-between items-center gap-4 font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black font-black">
          <p className="font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold"><span onClick={() => { setAdminPasswordInput(''); setAdminLoginError(false); setIsAdminOpen(true); }} className="cursor-default hover:text-slate-400 transition-colors font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold font-bold">©</span> 2014-至今 Happy Beetle (H.B. 快樂蟲坊). All rights reserved.</p>
        </div>
      </footer>
    </div>
  );
};

export default App;